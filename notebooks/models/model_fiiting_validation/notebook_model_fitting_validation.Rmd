---
title: 'Model fitting and validation'
author: "Erick Calderon-Morales"
date: ' Fall 2021'
due_date: ""
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 2

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,comment = "", fig.align = 'center',
					  fig.width = 11, fig.height = 7)
```


```{r knitr, include = FALSE}

# Save figures in specific place

knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,
                      
                      # Include code?
                      echo           = TRUE,
                      
                      error          = FALSE,
                      fig.align      = "center",
                      
                      # Path to where to store pdf single figures 
                      fig.path       = paste0("./figures_models_validation", "/"),
                      fig.width      = 11,
                      fig.height     = 7,
                      message        = FALSE,
                      warning        = FALSE)
```


```{r cleanup-docs, cache = FALSE,echo = FALSE}

# # save a html copy file in a specific place
# doc.files <- c(list.files(pattern = "pdf"),
#                list.files(pattern = "html"),
#                list.files(pattern = "docx"))
# 
# for (file in doc.files) {
#   cambiar nombre
#     file.rename(file, file.path("../../hw1/", file))
# }
```


```{r libaries, message=FALSE, warning=FALSE, cache=FALSE}
library(dplyr)
# For Model fitting
library(lme4)
library(nlme)
library(purrr)
# For diagnostics
library(performance)
# For adding new columns
library(tibble)
library(MuMIn)
```

```{r message=FALSE, warning=FALSE}
# Load data
sys.source("./scripts/code_join_data_full_dataset.R", envir = knitr::knit_global())
```


```{r message=FALSE, warning=FALSE}
# Load functions
## Models
sys.source("./R/functions_models.R", envir = knitr::knit_global())
sys.source("./R/function_nlme_validation_plots.R", envir = knitr::knit_global())
```

# Model Fitting


## Models: Questions 1,2 and Mass fractions   


### Select performance and traits variables 


```{r}
data_for_models <-
    data_for_models %>%
        # Select variables for analysis
        dplyr::select(c(1:7,9,11:ncol(data_for_models)))
```



$$response\sim treatment*fixer\ + initial\ height + random( 1|\ specie)$$

```{r}
# Take response variables names 
response_vars_q1_q2 <- 
    set_names(names(data_for_models)[c(5:11, 12:15,17)])

response_vars_q1_q2 
```

```{r}
models_q1_q2_mass_fractions <- map(response_vars_q1_q2, ~ mixed_model_1(response = .x, 
                                                              data = data_for_models))
```

```{r}
# Log models

model_q2_wue_log <- lmer(log(wue) ~ nfixer*treatment + init_height + (1|spcode), 
                         data = data_for_models)

model_q2_pnue_log <- lmer(log(pnue) ~ nfixer*treatment + init_height + (1|spcode), 
                         data = data_for_models) 


model_rmf_log <- lmer(log(rmf) ~ nfixer*treatment + init_height + (1|spcode), 
                         data = data_for_models)

model_smf_log <- lmer(log(smf) ~ nfixer*treatment + init_height + (1|spcode), 
                         data = data_for_models) 

model_lmf_log <- lmer(log(lmf) ~ nfixer*treatment + init_height + (1|spcode), 
                         data = data_for_models) 

```

```{r}
# Append log models to model list Q1 Q2
log_models <- list(model_q2_wue_log, model_q2_pnue_log,
                   model_rmf_log, model_smf_log, model_lmf_log)


names(log_models) <- c("wue_log", "pnue_log", 
                       "rmf_log", "smf_log", "lmf_log")

models_q1_q2_mass_fractions <- append(log_models, models_q1_q2_mass_fractions)

length(models_q1_q2_mass_fractions)
names(models_q1_q2_mass_fractions)
```

## Model: Nodule count

+ Chapter 9 Mixed models in ecology check glmmML package for count data
+ GOOD ref https://www.dataquest.io/blog/tutorial-poisson-regression-in-r/
+ #https://www.flutterbys.com.au/stats/tut/tut11.2a.html

```{r}
# Load data
# This step was done like this because I am working with a subset of the data
# source cleaned data
source("./scripts/code_clean_data_nodules.R")

# Delete unused variables
data_nodules_cleaned <-
    data_nodules_cleaned %>%
        
        # add id to rownames for keep track of the rows
        column_to_rownames("id") %>% 
        dplyr::select(spcode,treatment, everything())

```

### lmer gaussian      

```{r}
lmer_gaussian <- lmer(number_of_root_nodulation ~ treatment + init_height + 
                           (1 |spcode),data = data_nodules_cleaned)
```


### lmer gaussian log  

```{r}
lmer_gaussian_log <-  lmer(log(number_of_root_nodulation) ~ treatment + init_height + 
                           (1 |spcode),data = data_nodules_cleaned)
```

#### Compare models
```{r}
# Based on this output I decided to use the log model
MuMIn::model.sel(lmer_gaussian, lmer_gaussian_log)
```

```{r}
AIC(lmer_gaussian, lmer_gaussian_log)
```

### Improving log model

```{r}
## After seeing the validation plots for the lmer_gaussian_log I decided to try 
## to improve the log model using the nlme package


nlme_gaussian_log <- lme(log(number_of_root_nodulation) ~ treatment + init_height,
                                    random = ~1|spcode,
                                    data = data_nodules_cleaned)



nlme_nodule_log_weights <- lme(log(number_of_root_nodulation) ~ treatment + init_height,
                                    random = ~1|spcode,
                                    weights = varIdent(form = ~1|spcode),
                                    data = data_nodules_cleaned)
```

#### Compare models
```{r}
# Check if the nlme_gaussian_log_weights is a better model

# Compare between nlme objects
anova(nlme_gaussian_log, nlme_nodule_log_weights )

model.sel(nlme_gaussian_log, lmer_gaussian_log,  nlme_nodule_log_weights)

AIC(lmer_gaussian_log, nlme_gaussian_log, nlme_nodule_log_weights)
# Model improved, check assumptions for nlme_gaussian_log_weights 

```


## Models: Question 3


$$performance\sim treatment:fixer:scaled(trait)\ + initial\ height + random( 1|\ specie)$$

### Scale preditors 

```{r}
data_for_models_scaled <-
    data_for_models %>% 
        mutate(across(c(4,9:14),scale)) 
```


### Model Aboveground biomass

```{r}
lme_above_biom_3way <- lme(above_biomass ~  treatment:nfixer:amax +
                                            treatment:nfixer:gs  +
                                            treatment:nfixer:wue +
                                            treatment:nfixer:pnue +
                                            treatment:nfixer:d13c +
                                            init_height ,
                    random = ~1 | spcode, 
                    data = data_for_models_scaled)
```

### Model Belowground biommass

```{r}
lme_below_biom_3way <- lme(below_biomass ~  treatment:nfixer:amax +
                                            treatment:nfixer:gs  +
                                            treatment:nfixer:wue +
                                            treatment:nfixer:pnue +
                                            treatment:nfixer:d13c +
                                            init_height ,
                    random = ~1 | spcode, 
                    data = data_for_models_scaled)
```

### Model RGR

```{r}
lme_rgr_3way <- lme(rgr ~   treatment:nfixer:amax +
                            treatment:nfixer:gs  +
                            treatment:nfixer:wue +
                            treatment:nfixer:pnue +
                            treatment:nfixer:d13c +
                            init_height ,
                  random = ~1 | spcode, 
                  data = data_for_models_scaled)
```


### Model Total Biomass

```{r}
lme_total_biom_3way <- lme(total_biomass ~  treatment:nfixer:amax +
                                            treatment:nfixer:gs  +
                                            treatment:nfixer:wue +
                                            treatment:nfixer:pnue +
                                            treatment:nfixer:d13c +
                                            init_height,
                            random = ~1 | spcode, 
                            data = data_for_models_scaled)
```


# Model Validation  


## Validation of models for questions 1,2 and Mass fractions 

### Collinearity

```{r collinearity_q1_q2}
map(models_q1_q2_mass_fractions, check_collinearity)
```


```{r validation_plots_q1_q2,fig.height = 15, fig.width = 10}
# No problems found here
map(models_q1_q2_mass_fractions, check_model)
```


## Validation of nodule count models 

### Checking log nodule count model's assumptions

```{r,validation_plots_lme_nodule_log, fig.height = 14, fig.width = 12}
check_model(lmer_gaussian_log)
```

```{r nlme_validation_func_lme_nodule_log, fig.height = 9, fig.width = 14}
nlme_validation_plots(lmer_gaussian_log, data = data_nodules_cleaned, 
                      group = "spcode", variables = c("treatment"))
```

#### Checking improved nlme log model assumptions

Zuur et al pp 84:

"Note that these residuals still show heterogeneity, but this is now allowed 
(because the residual variation differs depending on the chosen variance 
structure and values of the variance covariate). Hence, these residuals are 
less useful for the model validation process."

```{r, validation_plots_nodule_log_weights,  fig.height = 9, fig.width = 14}
nlme_validation_plots(nlme_nodule_log_weights, data = data_nodules_cleaned,
                      group = "spcode", variables = c("treatment") )
```


## Validation of models for question 3

### Aboveground biomass

```{r validation_lme_above_biom_3way, fig.height = 9, fig.width = 14}
nlme_validation_plots(lme_above_biom_3way, data = data_for_models_scaled,
                      group = "spcode")
```


### Belowground biomass

```{r validation_lme_below_biom_3way, fig.height = 9, fig.width = 14}
nlme_validation_plots(lme_below_biom_3way, data = data_for_models_scaled,
                      group = "spcode")
```


### RGR biomass

```{r validation_rgr_3way, fig.height = 9, fig.width = 14}
nlme_validation_plots(lme_rgr_3way, data = data_for_models_scaled, group = "spcode")
```




### Total biomass

```{r validation_lme_total_biom_3way, fig.height = 9, fig.width = 14}
nlme_validation_plots(lme_total_biom_3way, data = data_for_models_scaled,
                      group = "spcode")
```




# Save model lists as .RData

## Nodule count

```{r}
models_nodule_count <- list(nlme_gaussian_log, nlme_nodule_log_weights)

names(models_nodule_count) <- c("nlme_gaussian_log", "nlme_gaussian_log_weights")
```

## 3way models

```{r}
models_3way_q3<- list(lme_above_biom_3way, lme_below_biom_3way,
                           lme_rgr_3way, lme_total_biom_3way)

names(models_3way_q3) <- c("lme_above_biom_3way", "lme_below_biom_3way",
                               "lme_rgr_3way", "lme_total_biom_3way")

```


```{r}
saveRDS(models_q1_q2_mass_fractions, file = "./processed_data/models_q1_q2_mass_fractions.RData") 
saveRDS(models_nodule_count, file = "./processed_data/models_nodule_count.RData") 
saveRDS(models_3way_q3, file = "./processed_data/models_3way_q3.RData")
```
