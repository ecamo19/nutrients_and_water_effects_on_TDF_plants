---
title: 'Model inference'
author: "Erick Calderon-Morales"
date: ' Fall 2021'
due_date: ""
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 1

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,comment = "", fig.align = 'center',
					  fig.width = 11, fig.height = 7)

options(knitr.graphics.auto_pdf = TRUE, scipen = 9999, digits = 10)
```


```{r knitr, include = FALSE}

# Save figures in specific place
knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,

                      options(digits = 3),
                      # I added this option for edit the pdf in inkscape
                      dev            = c( "png", "pdf"),
                      # Include code?
                      echo           = TRUE,

                      error          = FALSE,
                      fig.align      = "center",

                      # Path where figures are going to be store pdf single figures
                      fig.path       = paste0("../model_inference/figures_model_inference", "/"),
                      fig.width      = 11,
                      fig.height     = 7,
                      message        = FALSE,
                      warning        = FALSE)
```


```{r cleanup-docs, cache = FALSE,echo = FALSE}

# save a html copy file in a specific place
#doc.files <- c(list.files(pattern = "pdf"),
#               list.files(pattern = "html"),
#               list.files(pattern = "docx"))

#for (file in doc.files) {
#  cambiar nombre
#    file.rename(file, file.path("../../hw1/", file))
#}
```


```{r libaries, message=FALSE, warning = FALSE, cache = FALSE}
library(dplyr)
# For tables appearance
library(reactablefmtr)
# For cleaning colnames
library(janitor)
# For add column function
library(tibble)
library(purrr)
library(performance)
# For bootstrap confidence intervals
library(lmeresampler)
library(nlme)
library(lme4)
# For model comparison
library(MuMIn)
# For get preditions
library(modelr)
# For reporting results
library(report)
library(emmeans)
```


```{r}
# setwd for Rmarkdown
knitr::opts_knit$set(root.dir = "~/Documents/projects/nutrients_and_water_effects_2022/stats/")
```

```{r message=FALSE, warning=FALSE}
# Load dataset for adding predictions
sys.source("./scripts/code_join_data_full_dataset.R", envir = knitr::knit_global())
```

```{r message=FALSE, warning=FALSE}
# Load functions

## Inference
sys.source("./R/functions_inference_anova_and_tukey_tables.R", envir = knitr::knit_global())

## Plots
sys.source("./R/function_masomenos_plots.R", envir = knitr::knit_global())
```

```{r}
# Load models
models_q1_q2 <- readRDS("./processed_data/models_q1_q2.RData")

models_nodule_count <- readRDS("./processed_data/models_nodule_count.RData")

models_3way_q3 <- readRDS("./processed_data/models_3way_q3.RData")

```

# Models selected according validation plots

## Models: Q1 and Q2

```{r}
names(models_q1_q2)
```

## Nodule count selected model

```{r}
names(models_nodule_count)
```

## Q3 models selected

```{r}
names(models_3way_q3)
```


```{r echo = FALSE}

# Step done for getting predictions from nodule models
source("./scripts/code_clean_data_nodules.R")

data_pred_nodules <-
     data_nodules_cleaned %>%

         # add id to rownames for keep track of the rows
         dplyr::select(c("id", "spcode", "treatment", "init_height"))
```


# Load data

```{r}
set.seed(666)
```

```{r echo=FALSE}

# Step done for getting predictions from models for Q1 and Q2
data_for_models <-
    data_for_models %>%

        rownames_to_column("id") %>%

        # Remove unused variables
        dplyr::select(id, spcode, treatment, nfixer, init_height)

```

# Q1: Growth and biomass accumulation


## Anova

```{r}
models_q1_q2 %>%

    # Remove traits and mass fractions models
    purrr::list_modify("d13c" = NULL, "amax" = NULL, "gs" = NULL,
                       "wue_log" = NULL, "pnue_log" = NULL,
                       "nitrogen_log" = NULL ) %>%
    anova_table_tidy(., model_list = T)
```


## Tuckey comparisons

```{r}
models_q1_q2 %>%

    # Remove traits and mass fractions models
      purrr::list_modify("d13c" = NULL, "amax" = NULL, "gs" = NULL,
                       "wue_log" = NULL, "pnue_log" = NULL,
                       "nitrogen_log" = NULL) %>%

    tukey_table_tidy(., model_list = T, formula = "treatment|nfixer")
```

## Percentange change

```{r message=FALSE, warning=FALSE}
models_q1_q2 %>%

   # Remove traits and mass fractions models
      purrr::list_modify("d13c" = NULL, "amax" = NULL, "gs" = NULL,
                       "wue_log" = NULL, "pnue_log" = NULL,
                       "nitrogen_log" = NULL) %>%
    # Percentage difference
    emmeans_table_tidy(., model_list = T,
                        formula = "treatment|nfixer",
                        grouping_var = "nfixer")
```

## Plot Biomass and growth boxplot

```{r message=FALSE, warning=FALSE}

# Get predictions
string <- c("models_q1_q2")

data_pred_biomass_growth <-

        # Get models prediction
        gather_predictions(data_for_models,

                           # Return predictions of:
                            models_q1_q2$rgr,
                            models_q1_q2$total_biomass,
                            models_q1_q2$ratio_log)  %>%

            # Get fitted values
            pivot_wider(names_from = model, values_from = pred) %>%
             rename_all(
              funs(

                # rename columns
                stringr::str_to_lower(.) %>%

                # Remove string from name and replace it with pred_
                stringr::str_replace(., c(string),"pred_") %>%

                # Remove dollar sing
                gsub("\\$", "", .))) %>%
        # Select only pred variables
        dplyr::select(-init_height)
```

```{r warning=FALSE}

# Generate plot combinations
vars_q1 <-
  crossing(

    # Get all numeric variables to plot (all y)
    as_tibble(t(combn(dplyr::select(data_pred_biomass_growth, where(is.numeric)) %>% names, 1))),

    # Select factor variables to plot
    x_axis_var = dplyr::select(data_pred_biomass_growth, nfixer) %>%  names,
    group_var = dplyr::select(data_pred_biomass_growth, treatment) %>%  names)
```

```{r fig_1_biomass_growth_boxplot, fig.height = 6, fig.width = 7, fig.align = 'center'}
par(mfrow = c(2,2))
vars_q1 %>%
      # Gererate plots
      pmap( ~ boxplot_plot_pmap(data = data_pred_biomass_growth,
                                y = !!sym(..1), x = !!sym(..2),
                                fill = !!sym(..3)))
      #cowplot::plot_grid(plotlist = ., ncol = 2)
```

## r2 models

```{r}
models_q1_q2 %>%

    # Remove traits and mass fractions models
    # Remove traits and mass fractions models
      purrr::list_modify("d13c" = NULL, "amax" = NULL, "gs" = NULL,
                       "wue_log" = NULL, "pnue_log" = NULL,
                       "nitrogen_log" = NULL) %>%

    map(., r2) %>%
    unlist()
```

# Q2: Traits and Nodule count

## Anova and Tuckey comparisons

```{r}
models_q1_q2 %>%

    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL, "rgr" = NULL, "ratio_log" = NULL) %>%

    anova_table_tidy(., model_list = T)
```


### Models with significant interaction

```{r}
models_q1_q2 %>%

    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL, "rgr" = NULL, "ratio_log" = NULL,

                       # No interaction
                       "d13c" = NULL,

                       # This only responded to the treatments
                       "pnue_log" = NULL, "gs" = NULL, "nitrogen_log" = NULL ) %>%

    tukey_table_tidy(., model_list = T, formula = "treatment|nfixer")
```

### Models with signifcant treatment effect

```{r message=FALSE, warning=FALSE}
models_q1_q2 %>%

    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL, "rgr" = NULL, "ratio_log" = NULL,

                       "amax" = NULL,  "wue_log" = NULL,
                       "d13c" = NULL ) %>%

    tukey_table_tidy(., model_list = T, formula = "treatment")
```

### Models with signifcant nfixer effect

```{r}
models_q1_q2 %>%

    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL,
                       "rgr" = NULL, "ratio_log" = NULL,

                       "amax" = NULL, "d15n" = NULL,
                       "wue_log" = NULL, "d13c" = NULL, "pnue_log" = NULL) %>%

    tukey_table_tidy(., model_list = T, formula = "nfixer")
```

## Percentange change

### Models with significant interaction

```{r}
models_q1_q2 %>%

    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL, "rgr" = NULL, "ratio_log" = NULL,


                       # No interaction
                       "d13c" = NULL,

                       # These variables only responded to the treatments
                       "pnue_log" = NULL, "gs" = NULL, "nitrogen_log" = NULL) %>%

    # Percentage difference
    emmeans_table_tidy(., model_list = T,
                        formula = "treatment|nfixer",
                        grouping_var = "nfixer")
```

### Models with significant treatment effect

```{r}
models_q1_q2 %>%

    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL,
                        "rgr" = NULL, "ratio_log" = NULL,

                       "amax" = NULL, "wue_log" = NULL, "d13c" = NULL) %>%

    # Percentage difference
    emmeans_table_tidy(., model_list = T,
                        formula = "treatment")


```


### Models with signifcant nfixer effect

```{r}

# Difference in gs between fixer non fixers
# Percentage difference
as.data.frame(emmeans(models_q1_q2$gs,
                          specs = pairwise ~ "nfixer",
                          type = "response",
                          adjust = "tukey")$emmeans) %>%

        clean_names() %>%
        dplyr::select(-c(df,lower_cl, upper_cl,se)) %>%

        # Rename response to emmean, this is done when models is log


        mutate(difference = ((emmean - first(emmean))),
               perc_difference =((emmean - first(emmean) )/first(emmean))*100) %>%
        mutate_if(is.numeric, round, 3)
```


```{r}
as.data.frame(emmeans(models_q1_q2$nitrogen_log,
                          specs = pairwise ~ "nfixer",
                          type = "response",
                          adjust = "tukey")$emmeans)  %>%

        clean_names() %>%
        dplyr::select(-c(df, lower_cl, upper_cl, se)) %>%

        # Rename response to emmean, this is done when models is log


        mutate(difference = ((response - first(response))),
               perc_difference =((response - first(response) )/first(response))*100) %>%
        mutate_if(is.numeric, round, 3)

```


## Plot Traits boxplot

```{r}

string <- c("models_q1_q2")

data_pred_traits <-

        # Get models prediction
        gather_predictions(data_for_models,

                           # Return predictions
                            models_q1_q2$amax,
                            models_q1_q2$d13c,
                            models_q1_q2$gs,
                            models_q1_q2$wue_log,
                            models_q1_q2$pnue_log) %>%



        pivot_wider(names_from = model, values_from = pred) %>%
            rename_all(funs(

                # rename columns
                stringr::str_to_lower(.) %>%
                stringr::str_replace(., c(string),"pred_") %>%

                # Remove dollar sing
                gsub("\\$", "", .)
                )) %>%

        # Back transform log variables
        mutate(pred_wue = exp(pred_wue_log),
               pred_pnue = exp(pred_pnue_log)) %>%

        # Remove log predictions and init height
        dplyr::select(-c(init_height, pred_wue_log,pred_pnue_log ))
```


```{r}
vars_q2 <-
  crossing(

    # Get all numeric variables to plot (all y)
    as_tibble(t(combn(dplyr::select(data_pred_traits, where(is.numeric)) %>% names, 1))),

    # Select factor variables to plot
    x_axis_var = dplyr::select(data_pred_traits, nfixer) %>%  names,
    group_var = dplyr::select(data_pred_traits, treatment) %>%  names)
```

```{r fig_2_traits_q2_boxplot, fig.height = 6, fig.width = 7, fig.align = 'center'}
vars_q2 %>%
      # Gererate plots
      pmap( ~ boxplot_plot_pmap(data = data_pred_traits,
                                y = !!sym(..1), x = !!sym(..2),
                                fill = !!sym(..3)))
#      cowplot::plot_grid(plotlist = ., ncol = 2)

```


```{r}
models_q1_q2 %>%

    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL, "rgr" = NULL,"ratio_log" = NULL) %>%
    map(., r2) %>%
    unlist()


```


## Nodule count

```{r}
map(models_nodule_count, AIC)
```

```{r}
anova.lme(models_nodule_count$nlme_gaussian_log_weights, type = "marginal")
```


```{r}
# Interpretation: https://stats.oarc.ucla.edu/other/mult-pkg/faq/general/faqhow-do-i-interpret-a-regression-model-when-some-variables-are-log-transformed/
```


```{r}
as.data.frame(emmeans(models_nodule_count$nlme_gaussian_log_weights,
                           specs = pairwise ~ "treatment",
                           type = "response",
                           adjust =  "tukey")$contrast) %>%
         clean_names() %>%
         reactable()
```


```{r}
# Percentage difference
emmeans_table_tidy(models_nodule_count$nlme_gaussian_log_weights,
                        single_model = T,
                        formula = "treatment")

```




```{r}
models_nodule_count %>%
    #purrr::list_modify("rgr_slope" = NULL, "agr_log" = NULL, "gs_sqrt" = NULL) %>%
    map(., r2) %>%
    unlist()
```


# Q3: Do species modulate their traits in response to the addition of nutrients and/or water to increase biomass accumulation and growth rates?

For answering this question I fitted the following models focusing in the 3 way interaction:

$$response \sim\ treatment:nfixer:trait\ + initialheight\ + (1|spcode) $$

## r2

```{r}
map(models_3way_q3, r.squaredGLMM)
```

## Bootstraps

### Total Biomass

```{r}
# Look results before bootstrap
#report::report(models_3way_q3$lme_total_biom_3way)
```


```{r}

if (file.exists("./processed_data/bootstrap_ci_total_biomass.RData")) {

    print("The bootstrap exists")

    bootstrap_ci_total_biomass <- readRDS("./processed_data/bootstrap_ci_total_biomass.RData")

    print("File read")

} else {

    print("The bootstrap does not exist, Creating bootstrap")

    bootstrap_ci_total_biomass <-
        bootstrap_model_ci_df(model = models_3way_q3$lme_total_biom_3way,
                              category = "all",

                              iter = 9999)

    saveRDS(bootstrap_ci_total_biomass,
            file = "./processed_data/bootstrap_ci_total_biomass.RData")

}
```


#### Plot Total Biomass

```{r}

colmn <- paste0("col_", 1:3)

data_total_biomass_plot <-

        bootstrap_ci_total_biomass %>%

            unite("treat_trait", col_1, col_3, sep = "-", remove = F) %>%
            mutate(across(where(is.character), as.factor)) %>%
            filter(type == "norm") %>%
            mutate(treat_trait = factor(treat_trait, levels = c("plus_water_nutrients-amax",
                                                            "plus_water_nutrients-d13c" ,
                                                            "plus_water_nutrients-gs"   ,
                                                            "plus_water_nutrients-pnue" ,
                                                            "plus_water_nutrients-wue",
                                                            "plus_water-amax" ,
                                                            "plus_water-d13c",
                                                            "plus_water-gs"  ,
                                                            "plus_water-pnue",
                                                            "plus_water-wue",
                                                            "plus_nutrients-amax",
                                                            "plus_nutrients-d13c",
                                                            "plus_nutrients-gs"  ,
                                                            "plus_nutrients-pnue",
                                                            "plus_nutrients-wue" ,
                                                            "no_additions-amax",
                                                            "no_additions-d13c",
                                                            "no_additions-gs"  ,
                                                            "no_additions-pnue",
                                                            "no_additions-wue")))
```


```{r total_biomass_plot, fig.width = 30, fig.height = 15, fig.align = 'center'}
total_biomass_plot <-
    cleveland_plot(x = treat_trait, y = estimate,
                                     color = col_1,
                                     ci_lower = lower, ci_upper = upper,
                                     data = data_total_biomass_plot) +
        facet_wrap(.~col_2)

```


### RGR

```{r}
# Look results before bootstrap
#report::report_parameters(models_3way_q3$lme_rgr_3way)
```

```{r}
if (file.exists("./processed_data/bootstrap_ci_rgr.RData")) {

    print("The bootstrap exists")

    bootstrap_ci_rgr <- readRDS("./processed_data/bootstrap_ci_rgr.RData")

    print("File read")

} else {

    print("The bootstrap does not exist, Creating bootstrap")

    bootstrap_ci_rgr <-
        bootstrap_model_ci_df(model = models_3way_q3$lme_rgr_3way,
                              category = "all",

                                iter = 9999)
    saveRDS(bootstrap_ci_rgr,
            file = "./processed_data/bootstrap_ci_rgr.RData")
}
```

#### Plot RGR
```{r}
colmn <- paste0("col_", 1:3)

data_rgr_plot <-
    bootstrap_ci_rgr %>%
            unite("treat_trait", col_1, col_3, sep = "-", remove = F) %>%
            mutate(across(where(is.character), as.factor)) %>%
            filter(type == "norm") %>%
            mutate(treat_trait = factor(treat_trait, levels = c("plus_water_nutrients-amax",
                                                            "plus_water_nutrients-d13c" ,
                                                            "plus_water_nutrients-gs"   ,
                                                            "plus_water_nutrients-pnue" ,
                                                            "plus_water_nutrients-wue",
                                                            "plus_water-amax" ,
                                                            "plus_water-d13c",
                                                            "plus_water-gs"  ,
                                                            "plus_water-pnue",
                                                            "plus_water-wue",
                                                            "plus_nutrients-amax",
                                                            "plus_nutrients-d13c",
                                                            "plus_nutrients-gs"  ,
                                                            "plus_nutrients-pnue",
                                                            "plus_nutrients-wue" ,
                                                            "no_additions-amax",
                                                            "no_additions-d13c",
                                                            "no_additions-gs"  ,
                                                            "no_additions-pnue",
                                                            "no_additions-wue")))
```


```{r}
# Plot
rgr_plot <-
    cleveland_plot(x = treat_trait, y = estimate,
                           color = col_1,
                           ci_lower = lower, ci_upper = upper,
                            data = data_rgr_plot) +
    facet_grid(.~col_2)
```


## Root to shoot ratio

```{r}
if (file.exists("./processed_data/bootstrap_ci_ratio.RData")) {

    print("The bootstrap exists")

    bootstrap_ci_ratio <- readRDS("./processed_data/bootstrap_ci_ratio.RData")

    print("File read")

} else {

    print("The bootstrap does not exist, Creating bootstrap")

    bootstrap_ci_ratio <-
        bootstrap_model_ci_df(model = models_3way_q3$lme_3way_root_shoot_ratio,
                              category = "all",

                                iter = 9999)
    saveRDS(bootstrap_ci_rgr,
            file = "./processed_data/bootstrap_ci_ratio.RData")
}
```


#### Plot Root-Shoot Ratio

```{r}
colmn <- paste0("col_", 1:3)

data_ratio_plot <-
    bootstrap_ci_ratio %>%
            unite("treat_trait", col_1, col_3, sep = "-", remove = F) %>%
            mutate(across(where(is.character), as.factor)) %>%
            filter(type == "norm") %>%
            mutate(treat_trait = factor(treat_trait, levels = c("plus_water_nutrients-amax",
                                                            "plus_water_nutrients-d13c" ,
                                                            "plus_water_nutrients-gs"   ,
                                                            "plus_water_nutrients-pnue" ,
                                                            "plus_water_nutrients-wue",
                                                            "plus_water-amax" ,
                                                            "plus_water-d13c",
                                                            "plus_water-gs"  ,
                                                            "plus_water-pnue",
                                                            "plus_water-wue",
                                                            "plus_nutrients-amax",
                                                            "plus_nutrients-d13c",
                                                            "plus_nutrients-gs"  ,
                                                            "plus_nutrients-pnue",
                                                            "plus_nutrients-wue" ,
                                                            "no_additions-amax",
                                                            "no_additions-d13c",
                                                            "no_additions-gs"  ,
                                                            "no_additions-pnue",
                                                            "no_additions-wue")))
```

```{r}
# Plot
ratio_plot <-
    cleveland_plot(x = treat_trait, y = estimate,
                           color = col_1,
                           ci_lower = lower, ci_upper = upper,
                            data = data_ratio_plot) +
    facet_grid(.~col_2)
```




