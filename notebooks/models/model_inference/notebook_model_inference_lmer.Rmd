---
title: 'Model inference'
author: "Erick Calderon-Morales"
date: ' Fall 2021'
due_date: ""
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 1

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,comment = "", fig.align = 'center',
					  fig.width = 11, fig.height = 7)
options(knitr.graphics.auto_pdf = TRUE, scipen = 9999)

```


```{r knitr, include = FALSE}

# Save figures in specific place

knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,
                      
                      options(digits = 3), 
                      # I added this option for edit the pdf in inkscape
                      dev            = c( "png", "pdf"),
                      # Include code?
                      echo           = TRUE,
                      
                      error          = FALSE,
                      fig.align      = "center",
                      
                      # Path where figures are going to be store pdf single figures
                      fig.path       = paste0("../model_inference/figures_model_inference_lmer", "/"),
                      fig.width      = 11,
                      fig.height     = 7,
                      message        = FALSE,
                      warning        = FALSE)
```


```{r cleanup-docs, cache = FALSE,echo = FALSE}

# save a html copy file in a specific place
#doc.files <- c(list.files(pattern = "pdf"),
#               list.files(pattern = "html"),
#               list.files(pattern = "docx"))

#for (file in doc.files) {
#  cambiar nombre
#    file.rename(file, file.path("../../hw1/", file))
#}
```


```{r libaries, message=FALSE, warning = FALSE, cache = FALSE}
library(dplyr)
# For tables appearance
library(reactablefmtr)
# For cleaning colnames
library(janitor)
# For add column function
library(tibble)
library(purrr)
library(performance)
# For bootstrap confidence intervals
library(merTools)
# For model comparison
library(MuMIn)
# For get preditions
library(modelr)
# For reporting results
library(report)
```



```{r}
# Load dataset for adding predictions
sys.source("./scripts/code_join_data_full_dataset.R", envir = knitr::knit_global())
```

```{r}
# Load functions

## Inference
sys.source("./R/functions_inference_anova_and_tukey_tables.R", envir = knitr::knit_global())

## Plots
sys.source("./R/function_masomenos_plots.R", envir = knitr::knit_global())
```

```{r}
# Load models
models_q1_q2 <- readRDS("./processed_data/models_q1_q2.RData")

models_q3 <- readRDS("./processed_data/models_q3_3_way_interaction.RData")

models_nodule_count <- readRDS("./processed_data/models_list_nodule_count.RData")
```


```{r}
# Step done for getting predictions

data_for_models_transformed <- 
    data_for_models %>% 
        
        mutate(
            # Plant's performance
            total_biomass_sqrt = sqrt(total_biomass),
            above_biomass_sqrt = sqrt(above_biomass),
            below_biomass_log = log(below_biomass),
            agr_log = log(agr),
            
            # NO TRANSFORMATION variable already in log-log
            rgr = rgr,
            
            # NO TRANSFORMATION variable already in log-log
            rgr_slope = rgr_slope,
          
            # Traits
            amax_log = log(amax),
            gs_sqrt = sqrt(gs),
            wue_log = log(wue),
            
            # d13 and d15 where not transformed because the data has negative values
            pnue_log = log(data_for_models$pnue),
          
            # Covariate
            init_height = log(init_height)) %>%   
            
        # Remove original variables (non-transformed)
        dplyr::select(spcode, treatment, nfixer, init_height, everything(),
               -c(5:8,11:13,16))    
```

# Q1 and Q2

## Model comparison

```{r}
model.sel(models_q1_q2$rgr,
                    models_q1_q2$d13c,
                    models_q1_q2$d15n,
                    models_q1_q2$total_biomass_sqrt,
                    models_q1_q2$above_biomass_sqrt,
                    models_q1_q2$below_biomass_log,
                    models_q1_q2$amax_log,
                    models_q1_q2$wue_log,
                    models_q1_q2$pnue_log) %>% 
    reactable()
```

## Report

For example, the log transformed data above has a mean of 1.044 and a 95% 
confidence interval of Â±0.344 log-transformed fish. The back-transformed mean 
would be 101.044=11.1 fish. The upper confidence limit would be 10(1.044+0.344)=24.4 fish, 
and the lower confidence limit would be 10(1.044-0.344)=5.0 fish


```{r}
models_q1_q2 %>% 
    
    # Remove models
    purrr::list_modify("rgr_slope" = NULL, "agr_log" = NULL, "gs_sqrt" = NULL) %>%  
    map(., report)

```

```{r}
models_q1_q2 %>% 
    
    # Remove models
    purrr::list_modify("rgr_slope" = NULL, "agr_log" = NULL, "gs_sqrt" = NULL) %>%  
    map(., report_effectsize)

```

```{r}
#simulate_coefs(models_q1_q2$total_biomass_sqrt, iter = 100, interaction_3way = FALSE)
```


```{r fig.height = 12, fig.width = 12}
models_q1_q2 %>% 
    
    # Remove models
    purrr::list_modify("rgr_slope" = NULL, "agr_log" = NULL, "gs_sqrt" = NULL) %>% 
    plot_simulate_conf_int(., iter = 100, interact_3way = F)
```


```{r}
#as.data.frame(fitted(models_q1_q2$total_biomass_sqrt)) %>% 
#    rename(total_biomass_sqrt = "fitted(models_q1_q2$total_biomass_sqrt)" ) %>%
#    mutate(total_biomas = (total_biomass_sqrt)^2)
```


## Return data set with predicted values for backtranformations

```{r}
# Pattern to remove
string <- c("models_q1_q2")

#data_with_predictions_q1_q2_backtrans <- 
        
        # Get models prediction
        gather_predictions(data_for_models_transformed,
                           
                           # Return predictions 
                            models_q1_q2$rgr,
                            models_q1_q2$d13c,
                            models_q1_q2$d15n,
                            models_q1_q2$total_biomass_sqrt,
                            models_q1_q2$above_biomass_sqrt,
                            models_q1_q2$below_biomass_log,
                            models_q1_q2$amax_log,
                            models_q1_q2$wue_log,
                            models_q1_q2$pnue_log) %>% 
            
            
            pivot_wider(names_from = model, values_from = pred) %>% 
             rename_all(
              funs(
                # rename columns
                stringr::str_to_lower(.) %>%
                stringr::str_replace(., c(string),"pred_") %>% 
                
                # Remove dollar sing    
                gsub("\\$", "", .)
                )) %>%
    
        # Remove original vars
        dplyr::select(-c(4:16))  %>% 
        
        # Backtransform vars
        mutate(
            
            # sqrt transform by x^2
            pred_total_biomass_2 = (pred_total_biomass_sqrt)^2  ,
            pred_above_biomass_2 = (pred_above_biomass_sqrt)^2 ,
            
            # log transform by e^x
            pred_below_biomass_exp  = exp(pred_below_biomass_log),
            pred_amax_exp = exp(pred_amax_log),
            pred_wue_exp  = exp(pred_wue_log),
            pred_pnue_exp = exp(pred_pnue_log)) %>% 
            
            # Remove non-transformed vars from model
            dplyr::select(-c(7:12))  %>% 
        group_by(treatment, nfixer) %>% 
        summarise(across(where(is.numeric), mean)) %>% 
        arrange(nfixer)  %>% 
        mutate(across(4:10, round, 3)) %>% 
        reactable()
        
```

```{r}
map(models_q1_q2, r2)
```

## Nodule count

```{r}
model.sel(models_nodule_count$lmer_gaussian,
          models_nodule_count$glmer_poisson)
```




## r2

```{r}
models_nodule_count %>% 
    #purrr::list_modify("rgr_slope" = NULL, "agr_log" = NULL, "gs_sqrt" = NULL) %>%
    map(., r2)
```
# Q3

## Model comparisons

### Aboveground biomass

```{r}
model.sel(models_q3$`abovebiomasssqrt~amaxlog`,
                    models_q3$`abovebiomasssqrt~d13c`,
                    models_q3$`abovebiomasssqrt~d15n`,
                    models_q3$`abovebiomasssqrt~gssqrt`,
                    models_q3$`abovebiomasssqrt~pnuelog`,
                    models_q3$`abovebiomasssqrt~wuelog`)[,30:34]

```


## Belowgraound Biomass

```{r}
model.sel(models_q3$`belowbiomasslog~amaxlog`,
                    models_q3$`belowbiomasslog~d13c`,
                    models_q3$`belowbiomasslog~d15n`,
                    models_q3$`belowbiomasslog~gssqrt`,
                    models_q3$`belowbiomasslog~pnuelog`,
                    models_q3$`belowbiomasslog~wuelog`)[,30:34]
```

### rgr

```{r}
model.sel(models_q3$`rgr~amaxlog`,
                    models_q3$`rgr~d13c`,
                    models_q3$`rgr~d15n`,
                    models_q3$`rgr~gssqrt`,
                    models_q3$`rgr~pnuelog`,
                    models_q3$`rgr~wuelog`)[,30:34]

```


### Total Biomass

```{r}
model.sel(models_q3$`totalbiomasssqrt~amaxlog`,
                    models_q3$`totalbiomasssqrt~d13c`,
                    models_q3$`totalbiomasssqrt~d15n`,
                    models_q3$`totalbiomasssqrt~gssqrt`,
                    models_q3$`totalbiomasssqrt~pnuelog`,
                    models_q3$`totalbiomasssqrt~wuelog`)[,30:34]
```

## Plots

__Los intervalos coinciden con los pvalues????__

```{r, fig.width = 10, fig.height = 7}
names(models_q3)
models_q3 %>% 
    # Remove models
    purrr::list_modify("abovebiomasssqrt~gssqrt" = NULL, 
                       "belowbiomasslog~gssqrt" = NULL,
                       "totalbiomasssqrt~gssqrt" = NULL,
                       
                       "agrlog~gssqrt" = NULL,
                       "agrlog~pnuelog" = NULL,
                       "agrlog~wuelog" = NULL,
                       "agrlog~amaxlog" = NULL,
                       "agrlog~d13c" = NULL,
                       "agrlog~d15n" = NULL,
                       "rgr~gssqrt" = NULL,
                      
                       "rgrslope~amaxlog"   = NULL,         
                       "rgrslope~d13c"      = NULL,         
                       "rgrslope~d15n"      = NULL,         
                       "rgrslope~gssqrt"    = NULL,
                       "rgrslope~pnuelog"   = NULL,
                       "rgrslope~wuelog"    = NULL) %>% 

    plot_simulate_conf_int(. , interact_3way = T, iter = 100)
```


```{r}




