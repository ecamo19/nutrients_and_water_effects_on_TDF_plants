---
title: 'Model inference'
author: "Erick Calderon-Morales"
date: ' Fall 2021'
due_date: ""
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 1

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,comment = "", fig.align = 'center',
					  fig.width = 11, fig.height = 7)
options(knitr.graphics.auto_pdf = TRUE, scipen = 9999)

```


```{r knitr, include = FALSE}

# Save figures in specific place

knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,
                      
                      options(digits = 3), 
                      # I added this option for edit the pdf in inkscape
                      dev            = c( "png", "pdf"),
                      # Include code?
                      echo           = TRUE,
                      
                      error          = FALSE,
                      fig.align      = "center",
                      
                      # Path where figures are going to be store pdf single figures
                      fig.path       = paste0("../model_inference/figures_model_inference_lmer", "/"),
                      fig.width      = 11,
                      fig.height     = 7,
                      message        = FALSE,
                      warning        = FALSE)
```


```{r cleanup-docs, cache = FALSE,echo = FALSE}

# save a html copy file in a specific place
#doc.files <- c(list.files(pattern = "pdf"),
#               list.files(pattern = "html"),
#               list.files(pattern = "docx"))

#for (file in doc.files) {
#  cambiar nombre
#    file.rename(file, file.path("../../hw1/", file))
#}
```


```{r libaries, message=FALSE, warning = FALSE, cache = FALSE}
library(dplyr)
# For tables appearance
library(reactablefmtr)
# For cleaning colnames
library(janitor)
# For add column function
library(tibble)
library(purrr)
library(performance)
# For bootstrap confidence intervals
library(merTools)
# For model comparison
library(MuMIn)
# For get preditions
library(modelr)
# For reporting results
library(report)
```


```{r message=FALSE, warning=FALSE}
# Load dataset for adding predictions
sys.source("./scripts/code_join_data_full_dataset.R", envir = knitr::knit_global())
```

```{r message=FALSE, warning=FALSE}
# Load functions

## Inference
sys.source("./R/functions_inference_anova_and_tukey_tables.R", envir = knitr::knit_global())

## Plots
sys.source("./R/function_masomenos_plots.R", envir = knitr::knit_global())
```

```{r}
# Load models
models_q1_q2 <- readRDS("./processed_data/models_q1_q2.RData")

models_q3 <- readRDS("./processed_data/models_q3_3_way_interaction.RData")

models_nodule_count <- readRDS("./processed_data/models_list_nodule_count.RData")
```

```{r}
set.seed(666)
```

```{r echo=FALSE}
#Step done for getting predictions from models
data_for_models_transformed <- 
    data_for_models %>% 
        
        mutate(

            # Traits
            amax_log = log(amax),
            gs_log = log(gs),
            wue_log = log(wue),
            
            # d13 and d15 where not transformed because the data has negative values
            pnue_log = log(data_for_models$pnue),
          
            # Covariate
            init_height = log(init_height)) %>%   
            
        # Remove original variables (non-transformed)
        dplyr::select(spcode, treatment, nfixer, init_height, everything(),
               -c(5:8,11:13,16))   
```

# Q1 Growth and biomass accumulation

## Plot 

```{r}
string <- c("models_q1_q2")

data_pred_biomass_growth <- 
        
        # Get models prediction
        gather_predictions(data_for_models_transformed,
                           
                           # Return predictions 
                            models_q1_q2$rgr,
                       
                            models_q1_q2$total_biomass,
                            models_q1_q2$above_biomass,
                            models_q1_q2$below_biomass) %>% 
                       
            
            
            pivot_wider(names_from = model, values_from = pred) %>% 
             rename_all(
              funs(
                # rename columns
                stringr::str_to_lower(.) %>%
                stringr::str_replace(., c(string),"pred_") %>% 
                
                # Remove dollar sing    
                gsub("\\$", "", .)
                )) %>% 
    
        # Remove original vars
        dplyr::select(-c(4:12))  
```

```{r}
vars_q1 <-  
  crossing(
    
    # Get all numeric variables to plot (all y)
    as_tibble(t(combn(dplyr::select(data_pred_biomass_growth, where(is.numeric)) %>% names, 1))),
    
    # Select factor variables to plot
    x_axis_var = dplyr::select(data_pred_biomass_growth, nfixer) %>%  names,
    group_var = dplyr::select(data_pred_biomass_growth, treatment) %>%  names)
```


```{r biomass_growth_q1_boxplot, fig.height = 7, fig.width = 7, fig.align = 'center'}
vars_q1 %>% 
      # Gererate plots
      pmap( ~ boxplot_plot_pmap(data = data_pred_biomass_growth,
                                y = !!sym(..1), x = !!sym(..2), 
                                fill = !!sym(..3))) %>% 
      cowplot::plot_grid(plotlist = ., ncol = 2)
    
```


## Report performance variables 

For example, the log transformed data above has a mean of 1.044 and a 95% 
confidence interval of Â±0.344 log-transformed fish. The back-transformed mean 
would be 101.044=11.1 fish. The upper confidence limit would be 10(1.044+0.344)=24.4 fish, 
and the lower confidence limit would be 10(1.044-0.344)=5.0 fish


```{r}
models_q1_q2 %>% 
    
    # Remove traits models
    purrr::list_modify("d13c" = NULL, "d15n"  = NULL, "amax_log" = NULL, 
                       "gs_log" = NULL, "wue_log" = NULL, "pnue_log" = NULL) %>%  
    map(., report)

```

```{r}
models_q1_q2 %>% 
    
    # Remove traits models
    purrr::list_modify("d13c" = NULL, "d15n"  = NULL, "amax_log" = NULL, 
                       "gs_log" = NULL, "wue_log" = NULL, "pnue_log" = NULL) %>%  
    map(., report_effectsize)

```

```{r}
models_q1_q2 %>%
    
    # Remove traits models
    purrr::list_modify("d13c" = NULL, "d15n"  = NULL, "amax_log" = NULL, 
                       "gs_log" = NULL,"wue_log" = NULL, "pnue_log" = NULL) %>% 
    anova_table_tidy(., model_list = T)
```

```{r}
models_q1_q2 %>%
    
    # Remove traits models
    purrr::list_modify("d13c" = NULL, "d15n"  = NULL, "amax_log" = NULL, 
                       "gs_log" = NULL, "wue_log" = NULL, "pnue_log" = NULL) %>% 
    tukey_table_tidy(., model_list = T, formula = "treatment|nfixer")
```
```{r message=FALSE, warning=FALSE}
models_q1_q2 %>%
    
    # Remove traits models
    purrr::list_modify("d13c" = NULL,"d15n"  = NULL, "amax_log" = NULL, 
                       "gs_log" = NULL, "wue_log" = NULL, "pnue_log" = NULL) %>% 
    
    # Percentage difference
    emmeans_table_tidy(., model_list = T, 
                        formula = "treatment|nfixer", 
                        grouping_var = "nfixer")
```


```{r}

models_q1_q2 %>%
    
    # Remove traits models
    purrr::list_modify("d13c" = NULL,"d15n"  = NULL, "amax_log" = NULL, 
                       "gs_log" = NULL, "wue_log" = NULL, "pnue_log" = NULL) %>%
    
    map(., r2)
```

# Q2 Traits and Nodule count

## Traits

```{r}
models_q1_q2 %>% 
    
    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL, "above_biomass"  = NULL, 
                       "below_biomass" = NULL, "rgr" = NULL) %>% 
    map(., report)
```


```{r}
models_q1_q2 %>% 
    
    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL, "above_biomass"  = NULL, 
                       "below_biomass" = NULL, "rgr" = NULL) %>%
    
    map(., report_effectsize)
```
```{r traits_coef_plot, fig.height = 7, fig.width = 7, fig.align = 'center'}
models_q1_q2 %>% 
    
    # Remove performance variables
    purrr::list_modify("total_biomass" = NULL, "above_biomass"  = NULL, 
                       "below_biomass" = NULL, "rgr" = NULL) %>%
    
    plot_simulate_conf_int(., iter = 1000, interact_3way = F)
```



## Nodule count

```{r}
model.sel(models_nodule_count$lmer_gaussian,
          models_nodule_count$glmer_poisson)
```




```{r}
models_nodule_count %>% 
    #purrr::list_modify("rgr_slope" = NULL, "agr_log" = NULL, "gs_sqrt" = NULL) %>%
    map(., r2)
```



# Q3

## Model comparisons

### Aboveground biomass

```{r}
model.sel(models_q3$`abovebiomass~amaxlog`,
                    models_q3$`abovebiomass~d13c`,
                    models_q3$`abovebiomass~d15n`,
                    models_q3$`abovebiomass~gslog`,
                    models_q3$`abovebiomass~pnuelog`,
                    models_q3$`abovebiomass~wuelog`)[,9:13]

```


### Belowgraound Biomass

```{r}
model.sel(models_q3$`belowbiomass~amaxlog`,
                    models_q3$`belowbiomass~d13c`,
                    models_q3$`belowbiomass~d15n`,
                    models_q3$`belowbiomass~gslog`,
                    models_q3$`belowbiomass~pnuelog`,
                    models_q3$`belowbiomass~wuelog`)[,9:13]
```

### rgr

```{r}
model.sel(models_q3$`rgr~amaxlog`,
                    models_q3$`rgr~d13c`,
                    models_q3$`rgr~d15n`,
                    models_q3$`rgr~gslog`,
                    models_q3$`rgr~pnuelog`,
                    models_q3$`rgr~wuelog`)[,9:13]

```


### Total Biomass

```{r}
model.sel(models_q3$`totalbiomass~amaxlog`,
                    models_q3$`totalbiomass~d13c`,
                    models_q3$`totalbiomass~d15n`,
                    models_q3$`totalbiomass~gslog`,
                    models_q3$`totalbiomass~pnuelog`,
                    models_q3$`totalbiomass~wuelog`)[,9:13]
```

## Plots

__Los intervalos coinciden con los pvalues????__
```{r}
anova_table_tidy(models_q3$`abovebiomass~amaxlog`, single_model = T)
#coef(models_q3$`abovebiomass~amaxlog`)
```

```{r, fig.width = 18, fig.height = 20, fig.align = 'center'}

models_q3 %>% 
    # Remove models
    plot_simulate_conf_int(. , interact_3way = T, iter = 1000)
```





```{r fig.width = 18, fig.height = 20, fig.align = 'center'}
pattern <- c('\\:')
colmn <- paste0("col_", 1:3)
test <-  purrr::map_dfr(models_q3, ~ simulate_coefs(., iter = 100, 
                                                    interaction_3way = T))  

test_2 <- 
tidyr::separate(
        data = test,
        col = term,
        sep = ":",
        into = colmn,
        remove = T) %>% 
         
       
    mutate(col_1 = case_when(
            col_1 == "treatmentno_additions" ~ "no_additions",
            col_1 == "treatmentplus_nutrients" ~ "plus_nutrients",
            col_1 == "treatmentplus_water" ~ "plus_water",
            col_1 == "treatmentplus_water_nutrients" ~ "plus_water_nutrients",
            
            TRUE ~ col_1)) %>% 
    
    mutate(col_2 = case_when(
            col_2 == "nfixerfixer" ~ "fixer",
            col_2 == "nfixernonfixer" ~ "nonfixer",

            TRUE ~ col_2)) %>%    
    arrange(col_2,col_1) %>%
    unite("term", 2:4, sep = ":",remove = TRUE) %>% 
    mutate(term = factor(term))

levels(test_2$term)

ggplot2::ggplot(data = test_2, 
               # Highlight significant terms
               aes(x = term, y = median, color = significance)) +

            
            ggplot2::geom_hline(yintercept = 0, colour = gray(1/2), lty = 2) +
            ggplot2::geom_point(position = position_dodge(width = .9)) +
            
            # 95% C.I
            ggplot2::geom_linerange(aes(ymin = lower,ymax = upper),
                                    lwd = 1, position = position_dodge(width = .9)) +
            
            # 99% C.I
            #geom_linerange(aes(ymin = !!yvar - !!se * interval2,
            #                   ymax = !!yvar + !!se * interval2),
            #               lwd = 1/2, position = position_dodge(width = .9)) +
            
            ggplot2::theme_bw() +
            
            ggplot2::theme(legend.position = "none",
                           axis.text.y   = element_text(size= 15),
                           axis.text.x   = element_text(size= 15),
                           axis.title.y  = element_text(size= 15),
                           axis.title.x  = element_text(size= 15),
                           panel.grid.major.y = element_blank(), 
                           panel.grid.minor = element_blank(),
                           axis.line = element_line(size = .4,colour = "black"),
                           panel.border = element_rect(colour = "black", fill= NA, 
                                                       size = 1.3)) +
            # Add name
            #labs(title = paste0(response_variable)) +
            
            # Significance colors
            ggplot2::scale_colour_manual(values = c("gray","black")) +
            ggplot2::ylab("Estimated effects of treatments (median +/- CI)") +
            ggplot2::xlab("") +
            
            ggplot2::facet_wrap(~ response_variable, scales = "free_x", ncol = 2) +
            
            
            ggplot2::coord_flip()

```

