---
title: 'Box-Cox transformations'
author: "Erick Calderon-Morales"
date: ' Fall 2021'
due_date: ""
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 1

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,comment = "", fig.align = 'center',
					  fig.width = 11, fig.height = 7)
```


```{r knitr, include = FALSE}

# Save figures in specific place

knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,
                      
                      # Include code?
                      echo           = TRUE,
                      
                      error          = FALSE,
                      fig.align      = "center",
                      
                      # Path to where to store pdf single figures 
                      fig.path       = paste0("./figures_box_cox", "/"),
                      fig.width      = 11,
                      fig.height     = 7,
                      message        = FALSE,
                      warning        = FALSE)
```


```{r cleanup-docs, cache = FALSE,echo = FALSE}

# # save a html copy file in a specific place
# doc.files <- c(list.files(pattern = "pdf"),
#                list.files(pattern = "html"),
#                list.files(pattern = "docx"))
# 
# for (file in doc.files) {
#   cambiar nombre
#     file.rename(file, file.path("../../hw1/", file))
# }
```


```{r libaries, message=FALSE, warning=FALSE, cache=FALSE}
library(dplyr)
library(purrr)
library(caret)
library(dlookr)
library(forecast)
```

```{r message=FALSE, warning=FALSE}
# Load data
sys.source("./scripts/code_join_data_full_dataset.R", envir = knitr::knit_global())
```



# Select performance and traits variables 

```{r}
data_for_models <- 
    data_complete %>%
        
        # Calculate nitrogen use efficiency column
        # I followed Leaf traits explaining the growth of tree 
        # species planted in a Central Amazonian disturbed area
         mutate(photo_nitrogen_use = (amax*sla_cm2_g*0.1)/perc_n) %>% 
        
        # select variables that are going to be used in the models
        select(id, spcode, treatment,nfixer, init_height, 
               
               # Plant preformance
               total_biomass, above_biomass, below_biomass, 
               agr, rgr, rgr_slope,
               
               # Traits
               amax, gs, wue, d13c, d15n, photo_nitrogen_use) %>% 
        mutate(id = factor(id))


data_for_models$nfixer <- relevel(data_for_models$nfixer,ref = "fixer" )

```


# Box-Cox transformation

```{r}

# Nonnormality and heterogeneity of variance were corrected by applying  box-cox transformation
box_cox <- 
    data_for_models %>%
        
        # Transforme only the traits
        select(5:ncol(data_for_models)) %>% 
        purrr::map(., ~ BoxCoxTrans(.x))
```

+ λ =  1.00: no transformation needed; produces results identical to original data
+ λ =  0.50: square root transformation
+ λ =  0.33: cube root transformation
+ λ =  0.25: fourth root transformation
+ λ =  0.00: natural log transformation
+ λ = -0.50: reciprocal square root transformation
+ λ = -1.00: reciprocal (inverse) transformation 


init_height = log good
[1] 0.1

total_biomass = sqrt good
[1] 0.4

above_biomass = closer to 1 no transformation
[1] 0.7

below_biomass = log good
[1] 0.1

agr = log good
[1] 0.2

rgr = NO tranformation variable in log-log units



rgr_slope = NO tranformation variable in log-log units


amax =  1/amax not good, use log
[1] -0.4

gs = sqrt good
[1] 0.3

wue = log good
[1] -0.1

d13c
[1] NA

d15n 
[1] NA

photo_nitrogen_use = log good
[1] 0.2



```{r}
data_for_models %>% 
    select(where(is.numeric), -amax) %>% 
    plot_normality(., left = "sqrt", right = "log")

```


```{r}
plot_normality(data_for_models, amax, left = "log", right = "1/x")
```
















